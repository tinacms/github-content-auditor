name: Audit Content with AI

on:
  workflow_dispatch:

permissions:
  models: read

jobs: 
  lists-posts:
    runs-on: ubuntu-latest
    outputs:
      items: ${{ steps.build.outputs.items }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Build matrix items (name + content)
        id: build
        run: |
          ITEMS="[]"
            for f in ./content/posts/*.mdx; do
            NAME="$(basename "$f")"
            CONTENT="$(jq -Rs . < "$f")"
            ITEMS=$(jq --arg name "$NAME" --argjson content "$CONTENT" \
                '. + [{name: $name, content: $content}]' <<< "$ITEMS")
            done
            jq -n --argjson items "$ITEMS" '$items'
            echo "items<<EOF" >> "$GITHUB_OUTPUT"
            echo "$ITEMS" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
  generate-feedback:
    needs: lists-posts
    runs-on: ubuntu-latest
    strategy:
      matrix:
        item: ${{ fromJson(needs.lists-posts.outputs.items) }}
    steps:
      - name: Call Model
        # TODO: Add docs for replacing this
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        id: call-model
        uses: actions/ai-inference@v1
        
        with:
          model: openai/gpt-3.5-turbo
          system-prompt: |
            You are an expert content auditor. Your task is to review the provided blog post content and provide constructive feedback on its quality, clarity, and engagement. Highlight strengths and suggest specific improvements.
          prompt: |
            Here is the content of the blog post:
            ${{ matrix.item.content }}
      - name: Show Output
        run: echo "${{ steps.call-model.outputs.result }}"

            # echo-posts:
  #   needs: lists-posts
  #   runs-on: ubuntu-latest
  #   strategy:
  #     matrix:
  #       item: ${{ fromJson(needs.lists-posts.outputs.items) }}
        
  #   steps:
    
  #     - name: Use both name and content from matrix
  #       env:
  #           FILE_NAME: ${{ matrix.item.name }}
  #           FILE_CONTENT: ${{ matrix.item.content }}
  #       run: |
  #         echo "Filename: $FILE_NAME"
  #         printf '%s\n' "$FILE_CONTENT"