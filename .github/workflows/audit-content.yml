name: Audit Content with AI

on:
  workflow_dispatch:
permissions:
  models: read
  contents: read
  issues: write
jobs: 
  run-ast-parser: 
    outputs:
      items: ${{ steps.run.outputs.items }}
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node
        uses: actions/checkout@v4
      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: "Run AST Parser"
        id: run
        run: |
          export RESP="$(curl -X POST \
            -H "Content-Type: application/json" \
            -H "X-Api-Key: 3062e1cd69c58ee894ee5b4a7b373d19e21d03b0" \
            -d '{"query": "query postConnection { postConnection { totalCount edges { cursor node { ... on Document { _sys { path } } } } } }"}' \
            https://content.tinajs.io/1.6/content/02e62100-71a7-4638-9442-06fddf27d187/github/main)"
          pnpm --dir=.github/scripts/parse-tina-response install
          ITEMS=$(pnpm --dir=.github/scripts/parse-tina-response --silent start)
          
          echo "items<<EOF" >> "$GITHUB_OUTPUT"
          echo "$ITEMS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
  generate-feedback:
    runs-on: ubuntu-latest
    needs: run-ast-parser
    strategy:
      # add a time buffer to avoid rate limiting
      max-parallel: 2
      matrix:
        item: ${{ fromJson(needs.run-ast-parser.outputs.items) }}
    steps: 
      - name: Call Model
        # TODO: Add docs for replacing this
        id: call-model
        uses: actions/ai-inference@v2
        with:
          model: mistral-ai/Ministral-3B
          system-prompt: |
            You are an expert content auditor. Your task is to review the provided blog post content and provide constructive feedback on its quality, clarity, and engagement. Highlight strengths and suggest specific improvements.
          prompt: |
            Here is the content of the blog post:
            ${{ matrix.item.content }}
      - name: "Log Issues"
        uses: actions/github-script@v8
        env:
          FILE_PATH: ${{ matrix.item.path }}
          FEEDBACK: ${{ steps.call-model.outputs.response }}
        with: 
          script:
            const { owner, repo } = context.repo;
            const title = `ðŸ¦™ Content audit | ${process.env.FILE_NAME}`;
            const body = [
              `### Description`,
              `${process.env.FEEDBACK}`,
              `### File Location`,
              `${process.env.FILE_PATH}`,
            ].join('\n');
            const res = await github.rest.issues.create({
              owner, repo, title, body, labels: ['ai-audit']
            });
            core.info(`Created issue \#${res.data.number}`);
