name: Audit Content with AI
on:
  workflow_dispatch:
permissions:
  models: read
  contents: read
  issues: write
jobs: 
  run-ast-parser: 
    outputs:
      items: ${{ steps.run.outputs.items }}
      links: ${{ steps.run.outputs.links }}
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node
        uses: actions/checkout@v4
      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 10
        env:
          TINA_TOKEN: ${{ secrets.TINA_TOKEN }}
          TINA_CLIENT_ID: ${{ secrets.TINA_CLIENT_ID }}
      - name: "Aggregate Content Paths from TinaCMS"
        id: run
        run: |
          cd .github/scripts/tina-helpers
          touch .env
          echo TINA_CLIENT_ID=${{ secrets.TINA_CLIENT_ID }} >> .env
          echo TINA_TOKEN=${{ secrets.TINA_TOKEN }} >> .env
          pnpm install
          PATHS=$(pnpm --silent run aggregate-links)
          CONTENTS=$(pnpm --silent run map-links-to-content)

          echo "items<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CONTENTS_JSON" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          echo "links<<EOF" >> "$GITHUB_OUTPUT"
          echo "$PATHS_JSON" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

  generate-feedback:
    runs-on: ubuntu-latest
    needs: run-ast-parser
    strategy:
      # add a time buffer to avoid rate limiting
      max-parallel: 2
      matrix:
        item: ${{ fromJson(needs.run-ast-parser.outputs.items) }}
    steps: 
      - name: Log matrix item content
        run: |
          echo "Processing file at path: ${{ matrix.item.path }}"
          echo "Content preview: "
          echo "${{ matrix.item.content }}" | head -n 10
      - name: Call Model
        # TODO: Add docs for replacing this
        id: call-model
        uses: actions/ai-inference@v2
        with:
          model: mistral-ai/Ministral-3B
          system-prompt: |
            You are an expert content auditor. Your task is to review the provided blog post content and provide constructive feedback on its quality, clarity, and engagement. Highlight strengths and suggest specific improvements.
          prompt: |
            Here is the content of the blog post:
            ${{ matrix.item.content }}
      - name: "Log Issues"
        uses: actions/github-script@v8
        env:
          FILE_PATH: ${{ matrix.item.path }}
          FEEDBACK: ${{ steps.call-model.outputs.response }}
        with: 
          script:
            const { owner, repo } = context.repo;
            const title = `ðŸ¦™ Content audit | ${process.env.FILE_PATH}`;
            const body = [
              `### Description`,
              `${process.env.FEEDBACK}`,
              `### File Location`,
              `${process.env.FILE_PATH}`,
            ].join('\n');
            const labels = ['ðŸ¤– Content Audit'];
            const res = await github.rest.issues.create({
              owner, repo, title, body, labels,
            });
            core.info(`Created issue \#${res.data.number}`);
