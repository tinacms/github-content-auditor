name: Audit Content with AI

on:
  workflow_dispatch:

permissions:
  models: read
  contents: read

jobs: 
  lists-posts:
    runs-on: ubuntu-latest
    outputs:
      items: ${{ steps.build.outputs.items }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Build matrix items (name + content)
        id: build
        run: |
          ITEMS="[]"
            for f in ./content/posts/*.mdx; do
            NAME="$(basename "$f")"
            CONTENT="$(jq -Rs . < "$f")"
            ITEMS=$(jq --arg name "$NAME" --argjson content "$CONTENT" \
                '. + [{name: $name, content: $content}]' <<< "$ITEMS")
            done
            jq -n --argjson items "$ITEMS" '$items'
            echo "items<<EOF" >> "$GITHUB_OUTPUT"
            echo "$ITEMS" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
  generate-feedback:
    needs: lists-posts
    runs-on: ubuntu-latest
    strategy:
      # add a time buffer to avoid rate limiting
      max-parallel: 2
      matrix:
        item: ${{ fromJson(needs.lists-posts.outputs.items) }}
    steps:
      - name: Call Model
        # TODO: Add docs for replacing this
        id: call-model
        uses: actions/ai-inference@v2
        with:
          model: mistral-ai/Ministral-3B
          
          system-prompt: |
            You are an expert content auditor. Your task is to review the provided blog post content and provide constructive feedback on its quality, clarity, and engagement. Highlight strengths and suggest specific improvements.
          prompt: |
            Here is the content of the blog post:
            ${{ matrix.item.content }}
      - name: "Log Issues"
        uses: actions/github-script@v8
        env:
          FILE_NAME: ${{ matrix.item.name }}
          FEEDBACK: ${{ steps.call-model.outputs.response }}
        with: 
          script:
            const { owner, repo } = context.repo;
            const title = `ðŸ¦™ Content audit | File ${process.env.FILE_NAME}`;
            const body = process.env.FEEDBACK || '(no feedback returned)';
            const res = await github.rest.issues.create({
              owner, repo, title, body,
            });
            core.info(`Created issue \#${res.data.number}`);
