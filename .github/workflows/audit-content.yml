name: Audit Content with AI

on:
  workflow_dispatch:

permissions:
  models: read

jobs: 
  lists-posts:
    runs-on: ubuntu-latest
    outputs:
      items: ${{ steps.build.outputs.items }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Build matrix items (name + content)
        id: build
        run: |
          ITEMS="[]"
            for f in ./content/posts/*.mdx; do
            NAME="$(basename "$f")"
            CONTENT="$(jq -Rs . < "$f")"
            ITEMS=$(jq --arg name "$NAME" --arg content "$CONTENT" \
                '. + [{name: $name, content: $content}]' <<< "$ITEMS")
            done
            echo "items<<EOF" >> "$GITHUB_OUTPUT"
            echo "$ITEMS" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
  echo-posts:
    needs: lists-posts
    runs-on: ubuntu-latest
    strategy:
      matrix:
        item: ${{ fromJson(needs.lists-posts.outputs.items) }}
    steps:
      - name: Use both name and content from matrix
        run: |
          echo "Filename: ${{ matrix.item.name }}"
          echo "Content (first 10 lines):"
          echo '${{ matrix.item.content }}' | head -n 10