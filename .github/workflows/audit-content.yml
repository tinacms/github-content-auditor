name: Audit Content with AI
on:
  workflow_dispatch:
permissions:
  models: read
  contents: write
  issues: write
  pull-requests: write
jobs: 
  query-tina-content: 
    outputs:
      items: ${{ steps.run.outputs.items }}
      links: ${{ steps.run.outputs.links }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: 
          fetch-depth: 0
      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: "Aggregate Content Paths from TinaCMS"
        id: run
        run: |
          cd .github/scripts/tina-helpers
          touch .env
          echo TINA_CLIENT_ID=${{ secrets.TINA_CLIENT_ID }} >> .env
          echo TINA_TOKEN=${{ secrets.TINA_TOKEN }} >> .env
          echo TINA_AUDITOR_COLLECTION='${{ vars.TINA_AUDITOR_COLLECTION }}' >> .env
          echo TINA_AUDITOR_EXPIRY_DAYS='${{ vars.TINA_AUDITOR_EXPIRY_DAYS }}' >> .env
          echo TINA_AUDITOR_CONTENT_WINDOW='${{ vars.TINA_AUDITOR_CONTENT_WINDOW }}' >> .env
          pnpm install
          PATHS=$(pnpm --silent run aggregate-links)
          CONTENTS=$(pnpm --silent run map-links-to-content "$PATHS")

          echo "items<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CONTENTS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          echo "links<<EOF" >> "$GITHUB_OUTPUT"
          echo "$PATHS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
  generate-feedback:
    runs-on: ubuntu-latest
    needs: query-tina-content
    strategy:
      max-parallel: 3
      matrix:
        item: ${{ fromJson(needs.query-tina-content.outputs.items) }}
    steps: 
      - name: Call Model
        id: call-model
        uses: actions/ai-inference@v2
        with:
          max-tokens: 1000
          model: mistral-ai/Ministral-3B
          system-prompt: ${{ vars.TINA_AUDITOR_SYSTEM_PROMPT || 'You are an expert content auditor. Your task is to review the provided markdown content and provide constructive feedback on its quality, clarity, relevance and engagement. You should highlight and suggest specific areas for improvement.' }}
          prompt: |
            Here is the content of the blog post:
            ${{ matrix.item.content }}
      - name: "Log Issues"
        uses: actions/github-script@v8
        env:
          FILE_PATH: ${{ matrix.item.path }}
          FEEDBACK: ${{ steps.call-model.outputs.response }}
        with: 
          script:
            const { owner, repo } = context.repo;
            const title = `ðŸ¦™ Content audit | ${process.env.FILE_PATH}`;
            const body = [
              `### Description`,
              `${process.env.FEEDBACK}`,
              `### File Location`,
              `${process.env.FILE_PATH}`,
            ].join('\n');
            const labels = ['ðŸ¤– Content Audit'];
            const res = await github.rest.issues.create({
              owner, repo, title, body, labels,
            });
            core.info(`Created issue \#${res.data.number}`);
  update-checked:
    runs-on: ubuntu-latest
    needs: [query-tina-content, generate-feedback]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: 
          fetch-depth: 0
      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with: 
          version: 10
      - name: Install deps
        run: pnpm --dir=.github/scripts/tina-helpers install
      - name: Run update-checked
        run: |
          pnpm --dir=.github/scripts/tina-helpers run update-checked '${{ needs.query-tina-content.outputs.links }}'
      - name: Format links for PR
        id: fmt
        run: |
          echo '${{ needs.query-tina-content.outputs.links }}' | jq -r '.[]' > links.txt
          echo "list<<EOF" >> "$GITHUB_OUTPUT"
          sed 's/^/- /' links.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          rm -rf links.txt
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "/actions/runs/${{ github.run_id }}: update lastChecked for selected files"
          branch: content-audit/flow/${{ github.run_id }}
          title: "ðŸ¤– Content Audit | update lastChecked /actions/runs/${{ github.run_id }}"
          body: |
            ### Description
            
            This PR updates the `lastChecked` timestamp for the following files based on the recent content audit:

            ### Files

            ${{ steps.fmt.outputs.list }}
            
            ### Workflow run:

            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
          labels: 'ðŸ¤– Content Audit'
